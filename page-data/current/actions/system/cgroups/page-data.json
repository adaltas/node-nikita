{"componentChunkName":"component---src-templates-action-js","path":"/current/actions/system/cgroups/","result":{"data":{"page":{"slug":"/current/actions/system/cgroups/","edit_url":"https://github.com/adaltas/node-nikita/edit/master/packages/system/src/cgroups.coffee.md","package":{"id":"1199c603-e361-545a-ae29-9aa93459d9d1","keywords":["nikita","build","cli","deploy","ssh","install","linux","system","sysctl","authconfig","cgroups","limits","mod"]},"name":"system.cgroups","version":{"alias":"current"},"parent":{"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Nikita action to manipulate cgroups. \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://linux.die.net/man/5/cgconfig.conf\"\n  }, \"cgconfig.conf(5)\"), \" describes the\\nconfiguration file used by libcgroup to define control groups, their parameters\\nand also mount points. The configuration file is identical on Ubuntu, RedHat\\nand CentOS.\"), mdx(\"h2\", {\n    \"id\": \"implementation\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#implementation\",\n    \"aria-label\": \"implementation permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Implementation\"), mdx(\"p\", null, \"When reading the current config, nikita uses \", mdx(\"code\", {\n    parentName: \"p\",\n    \"className\": \"language-text\"\n  }, \"cgsnapshot\"), \" command in order to\\nhave a well formatted file. It is available on CentOS with the \", mdx(\"code\", {\n    parentName: \"p\",\n    \"className\": \"language-text\"\n  }, \"libcgroup-tools\"), \"\\npackage.\"), mdx(\"p\", null, \"If docker is installed and started, informations about live containers could be\\nprinted, that's why all path under  docker/* are ignored.\"), mdx(\"h2\", {\n    \"id\": \"example\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#example\",\n    \"aria-label\": \"example permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Example\"), mdx(\"p\", null, \"Example of a group object:\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"bibi:\\n  perm:\\n    admin:\\n      uid: 'bibi'\\n      gid: 'bibi'\\n    task:\\n      uid: 'bibi'\\n      gid: 'bibi'\\n  controllers:\\n    cpu:\\n      'cpu.rt_period_us': '\\\"1000000\\\"'\\n      'cpu.rt_runtime_us': '\\\"0\\\"'\\n      'cpu.cfs_period_us': '\\\"100000\\\"'\"))), mdx(\"p\", null, \"Which will result in a file:\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"group bibi {\\n  perm {\\n    admin {\\n      uid = bibi;\\n      gid = bibi;\\n    }\\n    task {\\n      uid = bibi;\\n      gid = bibi;\\n    }\\n  }\\n  cpu {\\n    cpu.rt_period_us = \\\"1000000\\\";\\n    cpu.rt_runtime_us = \\\"0\\\";\\n    cpu.cfs_period_us = \\\"100000\\\";\\n  }\\n}\"))), mdx(\"h2\", {\n    \"id\": \"schema-definitions\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#schema-definitions\",\n    \"aria-label\": \"schema definitions permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Schema definitions\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"definitions =\\n  config:\\n    type: 'object'\\n    properties:\\n      'default':\\n        $ref: '#/definitions/group'\\n        description: '''\\n        The default object of cgconfig file.\\n        '''\\n      'groups':\\n        type: 'object'\\n        description: '''\\n        Object of cgroups to add to cgconfig file. The keys are the\\n        cgroup name, and the values are the cgroup configuration.\\n        '''\\n        patternProperties:\\n          '.*': # cgroup name\\n            $ref: '#/definitions/group'\\n        additionalProperties: false\\n      'ignore':\\n        type: 'array'\\n        items: type: 'string'\\n        description: '''\\n        List of group path to ignore. Only used when merging.\\n        '''\\n      'mounts':\\n        type: 'array'\\n        description: '''\\n        List of mount object to add to cgconfig file.\\n        '''\\n      'merge':\\n        type: 'boolean'\\n        default: true\\n        description: '''\\n        Default to true. Read the config from cgsnapshot command and merge\\n        mounts part of the cgroups.\\n        '''\\n      'target':\\n        type: 'string'\\n        description: '''\\n        The cgconfig configuration file. By default nikita detects provider\\n        based on  os.\\n        '''\\n    anyOf: [\\n      required: ['groups']\\n    ,\\n      required: ['mounts']\\n    ,\\n      required: ['default']\\n    ]\\n  group:\\n    type: 'object'\\n    description: '''\\n    Controllers in the cgroup where the keys represent the name of the\\n    controler.\\n    '''\\n    properties:\\n      perm:\\n        type: 'object'\\n        description: '''\\n        Object to describe the taks and limits permissions.\\n        '''\\n        properties:\\n          'admin':\\n            $ref: '#/definitions/group_perm'\\n            description: '''\\n            Who can manage limits\\n            '''\\n          'task':\\n            $ref: '#/definitions/group_perm'\\n            description: '''\\n            Who can add tasks to this group\\n            '''\\n      cpuset: $ref: '#/definitions/group_controller'\\n      cpu: $ref: '#/definitions/group_controller'\\n      cpuacct: $ref: '#/definitions/group_controller'\\n      blkio: $ref: '#/definitions/group_controller'\\n      memory: $ref: '#/definitions/group_controller'\\n      devices: $ref: '#/definitions/group_controller'\\n      freezer: $ref: '#/definitions/group_controller'\\n      net_cls: $ref: '#/definitions/group_controller'\\n      perf_event: $ref: '#/definitions/group_controller'\\n      net_prio: $ref: '#/definitions/group_controller'\\n      hugetlb: $ref: '#/definitions/group_controller'\\n      pids: $ref: '#/definitions/group_controller'\\n      rdma: $ref: '#/definitions/group_controller'\\n  group_perm:\\n    type: 'object'\\n    properties:\\n      'uid': oneOf: [\\n        type: 'integer'\\n      ,\\n        type: 'string'\\n      ]\\n      'gid': oneOf: [\\n        type: 'integer'\\n      ,\\n        type: 'string'\\n      ]\\n  group_controller:\\n    type: 'object'\\n    patternProperties:\\n      '.*': oneOf: [\\n        type: 'integer'\\n      ,\\n        type: 'string'\\n      ]\\n    additionalProperties: false\"))), mdx(\"h2\", {\n    \"id\": \"handler\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#handler\",\n    \"aria-label\": \"handler permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Handler\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"handler = ({config}) ->\\n  # throw Error 'Missing cgroups content' unless config.groups? or config.mounts? or config.default?\\n  config.mounts ?= []\\n  config.groups ?= {}\\n  config.merge ?= true\\n  config.cgconfig = {}\\n  config.cgconfig['mounts'] = config.mounts\\n  config.cgconfig['groups'] = config.groups\\n  config.cgconfig['groups'][''] = config.default if config.default?\\n  config.ignore ?= []\\n  config.ignore = [config.ignore] unless Array.isArray config.ignore\\n  # Detect Os and version\\n  {os} = await @system.info.os()\\n  # configure parameters based on previous OS dection\\n  store = {}\\n  if ['redhat','centos'].includes os.distribution\\n    {stdout} = await @execute\\n      $shy: true\\n      command: 'cgsnapshot -s 2>&1'\\n    cgconfig = utils.cgconfig.parse stdout\\n    cgconfig.mounts ?= []\\n    cpus = cgconfig.mounts.filter (mount) ->\\n      mount.type is 'cpu'\\n    cpuaccts = cgconfig.mounts.filter (mount) ->\\n      mount.type is 'cpuacct'\\n    # We choose a path which is mounted by default\\n    # if not @store['nikita:cgroups:cpu_path']?\\n    if cpus.length > 0\\n      store.cpu_path = cpus[0]['path'].split(',')[0]\\n      # @store['nikita:cgroups:cpu_path'] ?= cpu_path\\n    # a arbitrary path is given based on the\\n    else\\n      switch os.distribution\\n        when 'redhat', 'centos'\\n          majorVersion = os.version.split('.')[0]\\n          switch majorVersion\\n            when '6'\\n              store.cpu_path = '/cgroups/cpu'\\n            when '7'\\n              store.cpu_path = '/sys/fs/cgroup/cpu'\\n            else\\n              throw Error \\\"Nikita does not support cgroups for your RedHat or CentOS version}\\\"\\n        else throw Error \\\"Nikita does not support cgroups on your OS #{os.distribution}\\\"\\n    store.mount = \\\"#{path.posix.dirname store.cpu_path}\\\"\\n    # Running docker containers are remove from cgsnapshot output\\n    if config.merge\\n      groups = {}\\n      for name, group of cgconfig.groups\\n        groups[name] = group unless (name.indexOf('docker/') isnt -1) or (name in config.ignore)\\n      config.cgconfig.groups = merge groups, config.groups\\n      config.cgconfig.mounts.push cgconfig.mounts...\\n  # Write the configuration\\n  config.target ?= '/etc/cgconfig.conf' if ['redhat', 'centos'].includes os.distribution\\n  @file config,\\n    content: utils.cgconfig.stringify config.cgconfig\\n  cgroups:\\n    cpu_path: store.cpu_path\\n    mount: store.mount\"))), mdx(\"h2\", {\n    \"id\": \"exports\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#exports\",\n    \"aria-label\": \"exports permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Exports\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"module.exports =\\n  handler: handler\\n  metadata:\\n    definitions: definitions\"))), mdx(\"h2\", {\n    \"id\": \"dependencies\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#dependencies\",\n    \"aria-label\": \"dependencies permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Dependencies\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"utils = require './utils'\\n{merge} = require 'mixme'\\npath = require 'path'\"))));\n}\n;\nMDXContent.isMDXComponent = true;","tableOfContents":{"items":[{"url":"#nikitasystemcgroups","title":"nikita.system.cgroups","items":[{"url":"#implementation","title":"Implementation"},{"url":"#example","title":"Example"},{"url":"#schema-definitions","title":"Schema definitions"},{"url":"#handler","title":"Handler"},{"url":"#exports","title":"Exports"},{"url":"#dependencies","title":"Dependencies"}]}]},"excerpt":"nikita.system.cgroups Nikita action to manipulate cgroups.  cgconfig.conf(5)  describes the \nconfiguration file used by libcgroup to define control groups, their parameters \nand also mount points. Thâ€¦"}}},"pageContext":{}},"staticQueryHashes":["2288906906","393869461"]}