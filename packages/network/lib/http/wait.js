// Generated by CoffeeScript 2.7.0
// # `nikita.network.http.wait`

// Check if one or multiple hosts listen one or multiple ports periodically over an
// HTTP connection and continue once all the connections succeed. Status will be
// set to "false" if the user connections succeed right away, considering that no
// change had occured. Otherwise it will be set to "true".   

// ## Return

// Status is set to "true" if the first connection attempt was a failure and the 
// connection finaly succeeded.

// ## Schema definitions
var definitions, handler;

definitions = {
  config: {
    type: 'object',
    $ref: 'module://@nikitajs/network/lib/http#/definitions/config',
    properties: {
      'interval': {
        default: 2000, // see https://github.com/ajv-validator/ajv/issues/337
        // type: 'number'
        // description: '''
        // Time in millisecond between each connection attempt.
        // '''
        $ref: 'module://@nikitajs/network/lib/tcp/wait#/definitions/config/properties/interval'
      },
      status_code: {
        type: 'array',
        // default: [/^[1|2|3]\d{2}$/]
        default: ['1xx', '2xx', '3xx'],
        items: {
          oneOf: [
            {
              type: 'string'
            },
            {
              instanceof: 'RegExp'
            }
          ]
        }
      },
      // default: /^[1|2|3]\d{2}$/
      'timeout': {
        $ref: 'module://@nikitajs/network/lib/tcp/wait#/definitions/config/properties/timeout'
      }
    }
  }
};


// ## Handler
handler = async function({
    config,
    tools: {log}
  }) {
  var count, error, status_code;
  config.status_code = config.status_code.map(function(item) {
    if (typeof item === 'string') {
      item = new RegExp('^' + item.replaceAll('x', '\\d') + '$');
    }
    return item;
  });
  count = 0;
  while (true) {
    ({error, status_code} = (await this.network.http({
      $relax: true,
      method: config.method,
      url: config.url
    })));
    console.log('status_code', config.url, status_code);
    log({
      message: error ? `Attemp ${count} faild with error` : `Attemp ${count} return status ${status_code}`,
      attempt: count,
      status_code: status_code
    });
    if (!error && config.status_code.some(function(code) {
      return code.test(status_code);
    })) {
      return count > 0;
    }
    await this.wait(config.interval);
    count++;
  }
};

// ## Exports
module.exports = {
  handler: handler,
  metadata: {
    definitions: definitions
  }
};

// ## Dependencies

// url = require 'url'
// utils = require '../utils'
