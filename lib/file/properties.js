// Generated by CoffeeScript 1.12.4
var fs, quote, string;

module.exports = function(options) {
  var properties;
  options.log({
    message: "Entering file.properties",
    level: 'DEBUG',
    module: 'nikita/lib/file/properties'
  });
  if (!options.target) {
    throw Error("Missing argument options.target");
  }
  if (options.separator == null) {
    options.separator = '=';
  }
  if (options.content == null) {
    options.content = {};
  }
  if (options.sort == null) {
    options.sort = false;
  }
  properties = options.merge ? {} : options.content;
  options.log({
    message: "Merging \"" + (options.merge ? 'true' : 'false') + "\"",
    level: 'DEBUG',
    module: 'nikita/lib/file/properties'
  });
  this.call({
    "if": options.merge,
    handler: function(_, callback) {
      options.log({
        message: "Reading target \"" + options.target + "\"",
        level: 'DEBUG',
        module: 'nikita/lib/file/properties'
      });
      return fs.readFile(options.ssh, options.target, 'utf8', function(err, data) {
        var i, k, len, line, lines, ref, ref1, v;
        if (err) {
          return callback(err);
        }
        lines = string.lines(data);
        for (i = 0, len = lines.length; i < len; i++) {
          line = lines[i];
          if (/^\s*$/.test(line)) {
            continue;
          }
          if (/^#/.test(line)) {
            if (options.comment) {
              properties[line] = null;
            }
            continue;
          }
          ref = RegExp("^(.*?)" + (quote(options.separator)) + "(.*)$").exec(line), _ = ref[0], k = ref[1], v = ref[2];
          properties[k] = v;
        }
        ref1 = options.content;
        for (k in ref1) {
          v = ref1[k];
          if (v === null) {
            delete properties[k];
          } else {
            properties[k] = v;
          }
        }
        return callback();
      });
    }
  });
  return this.call(function() {
    var data, key, keys;
    keys = options.sort ? Object.keys(properties).sort() : Object.keys(properties);
    data = (function() {
      var i, len, results;
      results = [];
      for (i = 0, len = keys.length; i < len; i++) {
        key = keys[i];
        if (properties[key] != null) {
          results.push("" + key + options.separator + properties[key]);
        } else {
          results.push("" + key);
        }
      }
      return results;
    })();
    data = data.join('\n');
    return this.file({
      target: "" + options.target,
      content: data,
      backup: options.backup,
      eof: true
    });
  });
};

fs = require('ssh2-fs');

quote = require('regexp-quote');

string = require('../misc/string');
