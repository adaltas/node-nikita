// Generated by CoffeeScript 2.3.1
// # `nikita.system.chmod`

// Change the permissions of a file or directory.

// ## Options

// * `mode`   
//   Permissions of the file or the parent directory.   
// * `stats` (Stat instance, optional)   
//   Pass the Stat object relative to the target file or directory, to be
//   used as an optimization.     
// * `target`   
//   Where the file or directory is copied.   

// ## Callback Parameters

// * `err`   
//   Error object if any.   
// * `status`   
//   Value is "true" if file permissions was created or modified.   

// ## Example

// ```js
// require('nikita').system.chmod({
//   target: '~/my/project',
//   mode: 0o755
// }, function(err, status){
//   console.log(err ? err.message : 'File was modified: ' + status);
// });
// ```

// ## Source Code
var misc;

module.exports = function(options) {
  var ssh;
  this.log({
    message: "Entering chmod",
    level: 'DEBUG',
    module: 'nikita/lib/system/chmod'
  });
  if (options.stat) {
    console.log('Deprecated Option: receive options.stat instead of options.stats in system.chmod');
    options.stats = options.stat;
  }
  // SSH connection
  ssh = this.ssh(options.ssh);
  if (!options.target) {
    // Validate parameters
    throw Error(`Missing target: ${JSON.stringify(options.target)}`);
  }
  if (!options.mode) {
    throw Error("Missing option 'mode'");
  }
  this.call({
    unless: !!options.stats // Option 'stat' short-circuit
  }, function(_, callback) {
    this.log({
      message: `Stat information: "${options.target}"`,
      level: 'DEBUG',
      module: 'nikita/lib/system/chmod'
    });
    return this.fs.stat({
      ssh: options.ssh,
      target: options.target
    }, function(err, {stats}) {
      if (!err) {
        options.stats = stats;
      }
      return callback(err);
    });
  });
  return this.call(function(_, callback) {
    // Detect changes
    if (misc.mode.compare(options.stats.mode, options.mode)) {
      this.log({
        message: `Identical permissions on "${options.target}"`,
        level: 'INFO',
        module: 'nikita/lib/system/chmod'
      });
      return callback();
    }
    // Apply changes
    return this.fs.chmod({
      ssh: options.ssh,
      target: options.target,
      mode: options.mode,
      sudo: options.sudo
    }, function(err) {
      this.log({
        message: `Change permissions from "${options.stats.mode.toString(8)}" to "${options.mode.toString(8)}" on "${options.target}"`,
        level: 'WARN',
        module: 'nikita/lib/system/chmod'
      });
      return callback(err, true);
    });
  });
};

// ## Dependencies
misc = require('../misc');
