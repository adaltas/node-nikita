// Generated by CoffeeScript 2.3.1
// # `nikita.system.execute.assert`

// Assert a shell command.

// ## Options

// * `content` (string|buffer)   
//   Content to match, optional.
// * `cmd`   
//   String, Object or array; Command to execute.
// * `not` (boolean)   
//   Negates the validation.   
// * `trim` (boolean)   
//   Trim the actuel and expected content before matching, default is "false".

// ## Assert a command stdout

// ```javascript
// nikita.system.execute({
//   cmd: 'echo hello'
//   assert: 'hello'
// }, function(err){
//   console.log(err || 'ok');
// });
// ```

// ## Source Code
module.exports = function({options}) {
  if (options.trim == null) {
    options.trim = false;
  }
  if (Buffer.isBuffer(options.content)) {
    options.content = options.content.toString();
  }
  if (options.content && options.trim) {
    options.content = options.content.trim();
  }
  this.call({
    if: (options.content != null) && (typeof options.content === 'string' || Buffer.isBuffer(options.content))
  }, function() {
    return this.system.execute(options.cmd, function(err, {stdout}) {
      if (err) {
        throw err;
      }
      if (options.trim) {
        stdout = stdout.trim();
      }
      if (!options.not) {
        if (stdout !== options.content) {
          if (options.error == null) {
            options.error = `Invalid content: expect ${JSON.stringify(options.content.toString())} and got ${JSON.stringify(stdout.toString())}`;
          }
          err = Error(options.error);
        }
      } else {
        if (stdout === options.content) {
          if (options.error == null) {
            options.error = `Unexpected content: ${JSON.stringify(options.content.toString())}`;
          }
          err = Error(options.error);
        }
      }
      if (err) {
        throw err;
      }
    });
  });
  return this.call({
    if: (options.content != null) && options.content instanceof RegExp
  }, function() {
    return this.system.execute(options.cmd, function(err, {stdout}) {
      if (err) {
        throw err;
      }
      if (options.trim) {
        stdout = stdout.trim();
      }
      if (!options.not) {
        if (!options.content.test(stdout)) {
          if (options.error == null) {
            options.error = "Invalid content match";
          }
          err = Error(options.error);
        }
      } else {
        if (options.content.test(stdout)) {
          if (options.error == null) {
            options.error = "Unexpected content match";
          }
          err = Error(options.error);
        }
      }
      if (err) {
        throw err;
      }
    });
  });
};
